var editor;
$(document).ready(function() {
    
    var columnDefs = [{
        data: "id",
        title: "ID",
        type: "readonly"
      }, {
        data: "name",
        title: "Name",
         width: "30%"
      },{
        data: "description",
        title: "Description",
         width: "30%"
      }, {
         data: "pathlocal",
         title: "Pathlocal",
         width: "35%",
         type: "readonly"
      }, {
          data: "pathweb",
          title: "Pathweb",
          width: "10%"
      }, {
          data: "created_at",
          title: "Create",
          type: "readonly"
      }];

    var myTable;
  
    myTable = $('#example').DataTable({
        "sPaginationType": "full_numbers",
        dom: 'Bfrtip',
        ajax: '/programs',
        columns: columnDefs,
              columnDefs: [
                  {
                      render: function (data, type, full, meta) {
                          return "<div class='text-wrap width-200'><a target='_blank' href='/uploads/"+data+"'>" + data + "</a></div>";
                      },
                      targets: 3
                  }
               ],
              select: 'single',
              responsive: true,
              altEditor: true,     // Enable altEditor
              buttons: [{
                text: 'Add',
                name: 'add'        // do not change name
              },
              {
                extend: 'selected', // Bind to Selected row
                text: 'Edit',
                name: 'edit'        // do not change name
              },
              {
                extend: 'selected', // Bind to Selected row
                text: 'Delete',
                name: 'delete'      // do not change name
             }],
             onAddRow: function(datatable, rowdata, success, error) { 
                if($("#name").val().length > 1){
                    if($("#form-upload")[0][0].value.length > 1){

                        $('#form-upload').ajaxSubmit({
                            success:function(res) { 
                                rowdata.pathlocal=res;
                                 $.ajax({
                                     url: '/programs',
                                     type: 'post',
                                     dataType: 'json',
                                     contentType: 'application/json',
                                     data: JSON.stringify(rowdata),
                                     success: success,
                                     error: error
                                 })  
                             }            
                         });                         
                      }else{
                        $.ajax({
                            url: '/programs',
                            type: 'post',
                            dataType: 'json',
                            contentType: 'application/json',
                            data: JSON.stringify(rowdata),
                            success: success,
                            error: error
                        })
                      } 
                }else{
                    alert("LLena los campos")
                }       
                          
            },
            onEditRow: function(datatable, rowdata, success, error) {
                  

                /*
                $.ajax({
                    url: '/programs/'+rowdata.id,
                    type: 'put',
                    dataType: 'json',
                    contentType: 'application/json',
                    data: JSON.stringify(dataa),
                    success: success,
                    error: error
                })*/

                if($("#form-upload")[0][0].value.length > 1){
                    console.log('hay algo')
                    if(rowdata.pathlocal.length>1){
                        //subir archivo -- eliminar archivo
                        console.log('subir archivo -- eliminar archivo')
                        $('#form-upload').ajaxSubmit({
                            success:function(res) { 
                                ///rowdata.pathlocal=res;
                                 console.log("pasa creo"+res)
                                 $.ajax({
                                    url: '/deletefile',
                                    type: 'post',
                                    dataType: 'json',
                                    contentType: 'application/json',
                                    data: JSON.stringify({name: rowdata.pathlocal}),
                                    success: function(deleted){
                                        console.log("elimino bien")                                     
                                    }
                                })
                                var dataa= {
                                    name : rowdata.name,
                                    description : rowdata.description,
                                    pathlocal : res,
                                    pathweb : rowdata.pathweb
                                };                               
                                $.ajax({
                                    url: '/programs/'+rowdata.id,
                                    type: 'put',
                                    dataType: 'json',
                                    contentType: 'application/json',
                                    data: JSON.stringify(dataa),
                                    success: success,
                                    error: error
                                })                                  

                             }            
                         });


                    }else{
                        //subir archivo -- no eliminar
                        console.log('subir archivo -- no eliminar')
                        $('#form-upload').ajaxSubmit({
                            success:function(res) { 
                                ///rowdata.pathlocal=res;
                                
                                var dataa= {
                                    name : rowdata.name,
                                    description : rowdata.description,
                                    pathlocal : res,
                                    pathweb : rowdata.pathweb
                                };                               
                                $.ajax({
                                    url: '/programs/'+rowdata.id,
                                    type: 'put',
                                    dataType: 'json',
                                    contentType: 'application/json',
                                    data: JSON.stringify(dataa),
                                    success: success,
                                    error: error
                                })                                  

                             }            
                         });

                    }
                }else{
                    console.log('no hay')
                    if(rowdata.pathlocal.length>1){
                        //NO subir archivo -- eliminar archivo
                        console.log('NO subir archivo -- eliminar archivo')
                        $.ajax({
                            url: '/deletefile',
                            type: 'post',
                            dataType: 'json',
                            contentType: 'application/json',
                            data: JSON.stringify({name: rowdata.pathlocal}),
                            success: function(deleted){
                                console.log("elimino bien")                                     
                            }
                        })
                        var dataa= {
                            name : rowdata.name,
                            description : rowdata.description,
                            pathlocal : rowdata.pathlocal,
                            pathweb : rowdata.pathweb
                        };                               
                        $.ajax({
                            url: '/programs/'+rowdata.id,
                            type: 'put',
                            dataType: 'json',
                            contentType: 'application/json',
                            data: JSON.stringify(dataa),
                            success: success,
                            error: error
                        }) 
                    }else{
                        //NO subir archivo -- no eliminar
                        console.log('NO subir archivo -- no eliminar')
                        var dataa= {
                            name : rowdata.name,
                            description : rowdata.description,
                            pathlocal : rowdata.pathlocal,
                            pathweb : rowdata.pathweb
                        };                               
                        $.ajax({
                            url: '/programs/'+rowdata.id,
                            type: 'put',
                            dataType: 'json',
                            contentType: 'application/json',
                            data: JSON.stringify(dataa),
                            success: success,
                            error: error
                        }) 
                    }
                }



            },
            onDeleteRow: function(datatable, rowdata, success, error) {
                if(rowdata.pathlocal.length>1){
                    $.ajax({
                        url: '/deletefile',
                        type: 'post',
                        dataType: 'json',
                        contentType: 'application/json',
                        data: JSON.stringify({name: rowdata.pathlocal}),
                        success: function(deleted){
                            console.log("elimino bien")                                     
                        }
                    })  
                }

                $.ajax({
                    url: '/programs/'+rowdata.id,
                    type: 'delete',
                    dataType: 'json',
                    contentType: 'application/json',
                    success: success,
                    error: error
                });

            }
      });
    



});