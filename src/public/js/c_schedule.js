

$(document).ready(function() {
//Consultar



var columnDefs = [{
    data: "id",
    title: "ID",
    type: "readonly"
    
  }, {
    data: "name",
    title: "Name",
     width: "30%"
  }, {
    data: "id",
    title: "Acciones",
     width: "30%",
     type: "readonly"
  }
];
var myTable;
myTable = $('#example').DataTable({
    "sPaginationType": "full_numbers",
    dom: 'Bfrtip',
    ajax: '/api/schedule',
    columns: columnDefs,
          columnDefs: [
              {
                  render: function (data, type, full, meta) {
                      return "<div class='text-wrap width-200'><button class='btn btn-success btn-xs' onclick='usesc("+data+")'>Use</button></div>";
                  },
                  targets: 2
              }
           ],
          select: 'single',
          responsive: true,
          altEditor: true,     // Enable altEditor
          buttons: [{
            text: 'Add',
            name: 'add'        // do not change name
          },
          {
            extend: 'selected', // Bind to Selected row
            text: 'Edit',
            name: 'edit'        // do not change name
          },
          {
            extend: 'selected', // Bind to Selected row
            text: 'Delete',
            name: 'delete'      // do not change name
         }],
         onAddRow: function(datatable, rowdata, success, error) {   
             var data={
                 "name":rowdata.name
             }       
             $.ajax({
                 url: '/api/schedule',
                 type: 'post',
                 dataType: 'json',
                 contentType: 'application/json',
                 data: JSON.stringify(data),
                 success: success,
                 error: error
             })
         },onEditRow: function(datatable, rowdata, success, error) {
            var data={
                "name":rowdata.name
            }       
            $.ajax({
                url: '/api/schedule/'+rowdata.id,
                type: 'put',
                dataType: 'json',
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: success,
                error: error
            }) 
         },
         onDeleteRow: function(datatable, rowdata, success, error) {
             $.ajax({
                 url: '/api/schedule/'+rowdata.id,
                 type: 'delete',
                 dataType: 'json',
                 contentType: 'application/json',
                 success: success,
                 error: error
             });
         }

        });

$.ajax({
    url: '/api/schedule',
    type: 'get',
    dataType: 'json',
    success: (result)=>{
        console.log(result)
       

     //   $('#example').DataTable();
    }
});








});


var aux=0;
function additemaux(){

    aux++;
    $("#sc_tbody").append(`<tr>
    <td style="width: 52%" >
        ood truck fixie locavore, accusamus mcsweeney's marfa nulla single-origin 
         coffee squid. Exercitation +1 labore velit, blog sartorial PBR legg       
    </td>                                          
    <td state="1"  class="droppable drop1" style="width: 16%;background-color:yellow">
        <img class="draggable" src="https://www.w3schools.com/html/img_w3slogo.gif" alt="">
    </td>
    <td state="2"  class="droppable drop2" style="width: 16%"></td>
    <td state="3"  class="droppable drop3" style="width: 16%"></td>    
</tr>  `)
}

//abrir tab
function usesc(idsc){

    $("#ul_sc").append('<li><a href="#sc_'+idsc+'" data-toggle="tab">tab '+idsc+'</a></li>')
    $("#myTabContent_sc").append(`<div class="tab-pane " id="sc_${idsc}">
   
    </div>`)
    $("#sc_"+idsc).append(`<button class="btn btn-success btn-xs" onclick="sendAdditem(${idsc})">Add+</button>
    <table  cellpadding="0" cellspacing="0" border="0" class="dataTable table table-striped table-bordered"  style="margin-top: 1%;">
        <thead>
            <th>X</th>
            <th>tarea</th>
            <th colspan="3">Satus</th>
        </thead>
        <tbody id="sc_tbody_${idsc}">
           
        </tbody>
    </table>`)

    $("#sc_tbody_"+idsc).sortable({
        helper: fixHelper,
        axis: "y"
    }).disableSelection();
 
    $.ajax({
        url: '/api/itemsc/'+idsc,
        type: 'get',
        dataType: 'json',
        success: (result)=>{
            result.forEach(item => {
                console.log(item)
                $("#sc_tbody_"+idsc).append(`<tr>
                <td style="width: 5%" class="add_story"> x </td> 
                <td style="width: 52%" >
                    <textarea class="sci${item.id}_nameitem textareagg">${item.task}</textarea>      
                </td>                                          
                <td state="1"  class="sci${item.id}_droppable sci${item.id}_drop1" style="width: 16%;background-color:yellow">                </td>
                <td state="2"  class="sci${item.id}_droppable sci${item.id}_drop2" style="width: 16%"></td>
                <td state="3"  class="sci${item.id}_droppable sci${item.id}_drop3" style="width: 16%"></td>    
            </tr> `)
            
            //edititem
            $('.sci'+item.id+'_nameitem').focusout(function(data) {
                
                //console.log(data.target.value)
                sendNameItem(item.id,data.target.value)
              });

            //state

            switch(item.state){
                case 1:
                    $(".sci"+item.id+"_drop"+item.state).append(`<img class="sci${item.id}_draggable" src="https://www.w3schools.com/html/img_w3slogo.gif" alt="">`)
                    break;
                case 2:
                $(".sci"+item.id+"_drop"+item.state).append(`<img class="sci${item.id}_draggable" src="https://www.w3schools.com/html/img_w3slogo.gif" alt="">`)
                    break;
                case 3:
                    $(".sci"+item.id+"_drop"+item.state).append(`<img class="sci${item.id}_draggable" src="https://www.w3schools.com/html/img_w3slogo.gif" alt="">`)
                    break;
            }
            

            colordropp(item.id,item.state)

                //call dropp
                $(".sci"+item.id+"_droppable").droppable({
                    accept: ".sci"+item.id+"_draggable",
                    drop: function( event, ui ) {
                      cloned = ui.helper.clone().css({'position': '', 'top': '', 'left': ''});
                      setDraggable(cloned, false)
                      
                      
                      $( this )
                      .addClass( "ui-state-" )
                      .append(cloned)
                      ui.helper.remove();
                    
                      colordropp(item.id,$(this).attr("state"))
                      console.log($(this).attr("state"))

                      sendState(item.id,$(this).attr("state"))

                      
                    }
                  });
                  setDraggable($(".sci"+item.id+"_draggable"), false);

                  /*
                  $("#sc_tbody_"+idsc+" td").not('.add_story').mousedown(function(event){
                    event.stopImmediatePropagation();
                });*/

                  $('#ul_sc a[href="#sc_'+idsc+'"]').tab('show'); 



                
            });///fin item

            
        },
        complete: function(data) {
            $("#sc_tbody_"+idsc+" td").not('.add_story').mousedown(function(event){
                event.stopImmediatePropagation();
            });
        }
    });

   

    
    
    

}

var fixHelper = function (e, ui) {
    ui.children().each(function () {
        $(this).width($(this).width());
    });

    return ui;
};

function setDraggable(el, doClone) {
    el.draggable({
      helper: doClone ? 'clone' : 'original',
      revert: true
    });
  }
  function colordropp(id,state){
    $(".sci"+id+"_droppable").css("background-color","white");
 
     switch(parseInt(state)){
         case 1: $(".sci"+id+"_drop"+state).css("background-color","yellow"); break
         case 2: $(".sci"+id+"_drop"+state).css("background-color","orange"); break
         case 3: $(".sci"+id+"_drop"+state).css("background-color","green"); break
 
     }
     
 }

 