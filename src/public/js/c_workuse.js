$(document).ready(function() {

    var pathnames = window.location.pathname.split("/");
    var idwswork = pathnames[pathnames.length-2];


    $("#new_workKK").confirm({
        title: 'Confirm!',
        content: 'Simple confirm!',
        buttons: {
            confirm: function () {
                newwork(); 
            },
            cancel: function () {
                $.alert('Canceled!');
            }
        }
    });

    $(".nav-tabs").on("click", "a", function(e){
        e.preventDefault();
        $(this).tab('show');
      })
      .on("click", "span", function () {
         
         
        var anchor = $(this).siblings('a');
          $(anchor.attr('href')).remove();
          $(this).parent().remove();
          
          $(".nav-tabs li").children('a').first().click();
          
      });

    $(".select-ws").select2({
        theme: "bootstrap",
        width: 'resolve',
        ajax: {
            url: '/space_works/'+idwswork,
            processResults: function (data) {
                
              return {
                results: data
              };
            }
          }
      });
    
      $('#mislect').on('select2:select', function (e) {
        var data = e.params.data;
        console.log("abrir en tab project"+data.id);

        abrirworktab(data.id);


    });
    


    $('#sn_info').summernote({
        disableDragAndDrop: true,
        placeholder: 'Hello bootstrap 4',
        tabsize: 0.5,
        height: 200,
        blockquoteBreakingLevel: 2,
        lineHeight: 5
      });
      $('#sn_notes').summernote({
        disableDragAndDrop: true,
        placeholder: 'notas',
        toolbar: [
            // [groupName, [list of button]]
            ['style', ['bold', 'italic', 'underline', 'clear']],
            ['fontsize', ['fontname','fontsize',]],
            ['para', ['ul', 'ol', 'paragraph']]
        ],
        height:200
      });
      $('#sn_all').summernote({
        disableDragAndDrop: true,
        placeholder: 'notas',
        toolbar: [
            // [groupName, [list of button]]
            ['style', ['style','bold', 'italic', 'underline', 'clear']],
            ['fontsize', ['fontname','fontsize',]],
            ['para', ['ul', 'ol', 'paragraph']],
            ['para', ['height', 'hr', 'table', 'picture', 'link', 'video', 'redo', 'undo', 'codeview', 'fullscreen']]
        ],
        height:500
      });
      

      var pathname = window.location.pathname.split("/");
    var idw = pathname[pathname.length-1];
    var idws = pathname[pathname.length-2];

    console.log(idws);
    console.log(idw);
    

    $.ajax({
        url: '/workspace_works/'+idws+'/'+idw,
        type: 'get',
        success: (result)=>{
            $("#w_id").text(result.id);
            $("#ws_name").text(result.name);
            $("#wstype_id").text(result.type);
            $("#work_id").text(result.Works[0].id);    
            $("#w_name").text(result.Works[0].name);
            $("#w_host").text(result.Works[0].host);
            $("#sn_info").summernote('code',result.Works[0].inforelevant)
            $("#sn_notes").summernote('code',result.Works[0].inforeview);
            $("#sn_all").summernote('code',result.Works[0].infoall);
            $("#w_reportpdf").attr("href","/reportpdf/"+result.Works[0].id);
            $("#w_reporthtml").attr("href","/report/"+result.Works[0].id);
        }
    });

        
    $("#s_work").click(function() {
        var datas={                    
            "name" : $("#w_name").text(),
            "host": $("#w_host").text(),
            "inforelevant": $("#sn_info").summernote('code'),
            "inforeview": $("#sn_notes").summernote('code'),
            "infoall": $("#sn_all").summernote('code'),
            "state": true
        };
        console.log(datas)
        
        $.ajax({
            url: '/works/'+$("#work_id").text(),
            type: 'put',
            dataType: 'json',
            contentType: 'application/json',
            data: JSON.stringify(datas),
            success: (result)=>{
                console.log("datos del work save");
                msmnotication(true,'Update');
    
            },
            error: (result)=>{
                console.log(result);
                msmnotication(false,'Update');
            }
        });

    });

   


});

function newwork() {

    var datawork={                    
        "name" : "Work  "+getfecha(),
        "host": "192.168.0.1",
        "inforelevant": "<h4><h5><h3><h4><ul><li>URLs:</li></ul><ul><li>User :&nbsp;</li></ul><ul><li>Passwords:</li></ul><p><br></p></h4></h3></h5></h4>",
        "inforeview": "<h4></h4><h5></h5><h3></h3><p><ul></ul><ul></ul><ul></ul></p><ul><li><br></li><li><br></li><li><br></li></ul>",
        "infoall": "<p></p><p></p><p></p><p><span style='font-size: 24px;'>Pruebas realizadas</span></p><hr><p></p><p><br></p><p><br></p><p></p><hr><br><p></p><p><br></p><hr><br><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p><br></p><hr><p><br></p><p><br></p><p><br></p><hr><p><br></p>",
        "creationdate": "na",
        "state": true,
        "worksapce_id": $("#w_id").text()
    };       
    $.ajax({
        url: '/works',
        type: 'post',
        dataType: 'json',
        contentType: 'application/json',
        data: JSON.stringify(datawork),
        success: (datanewwork)=>{
            console.log("new proyec creado");
            $("#tab_name_work").append('<li><a href="#host_'+datanewwork.id+'" data-toggle="tab">Host '+datanewwork.id+'</a><span>x</span></li>');
            $("#tab_content_woks").append(rendertab(datanewwork));

            createsummernote("sn_info_"+datanewwork.id);
            createsummernote("sn_notes_"+datanewwork.id);
            createsummernote("sn_all_"+datanewwork.id);
            


            $('#tab_name_work a[href="#host_' + datanewwork.id + '"]').tab('show');            
        },
        error: (result)=>{
            console.log(result)
        }
    });

}

/**funciones */

function rendertab(data){
    var buildhtml=`<div class="tab-pane fade" id="host_${data.id}">
    <div class="content-work" style="padding: 12px;">
                                <table class="table table-bordered" style="margin-bottom: 5px;">
                                    <tbody>
                                      <tr class="success">
                                          
                                          <td style="width:12%;text-align: center; "><h4>HOST</h4></td>
                                        <th scope="row" style="width:30%"><h4 contenteditable="true" id="w_host_${data.id}">${data.host}</h4></th>                              
                                        <td style="width:25%"><H4 id="w_name_${data.id}" contenteditable="true">${data.name}</H4></td>
                                        <td style="width:30%">
                                          <button onclick="w_update_work(${data.id})" class="btn btn-primary">Save</button>
                                          
                                          
                                          <div id="work_id_${data.id}" class="hidden"></div>
                                          <a class="btn btn-warning" href="/report/${data.id}" target="_blank" >Html</a>
                                          <a class="btn btn-warning" href="/reportpdf/${data.id}" target="_blank">Pdf</a>
                                        </td>
                                        
                                      </tr>
                                    </tbody>
                                  </table>
                                <div class="row">
                                  <div class="col-lg-8" style="padding-right: 0px;">
                                      <div class="panel panel-primary" style="margin-bottom: 3px">
                                          <div class="panel-heading">
                                            <h3 class="panel-title">Relevant Information</h3>
                                          </div>
                                          <div class="panel-body">
                                              <div id="sn_info_${data.id}">
                                              ${data.inforelevant}
                                              </div>
                                          </div>
                                        </div>
                                        
                                        
                                  </div>
                                  <div class="col-lg-4">
                                      <div class="panel panel-primary" style="margin-bottom: 3px">
                                          <div class="panel-heading">
                                            <h3 class="panel-title">Notes To Review</h3>
                                          </div>
                                          <div class="panel-body">
                                            <div id="sn_notes_${data.id}">
                                            ${data.inforeview}
                                            </div>
                                          </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                  <div class="col-lg-12">
                                      <div class="panel panel-primary">                                          
                                          <div class="panel-body">
                                            <div id="sn_all_${data.id}">
                                            ${data.infoall}
                                            </div>
                                          </div>
                                        </div>
                                  </div>                                    
                                </div>  
                            </div>

  </div>`;


    return buildhtml;
}

function getfecha(){
    var f = new Date();
    return f.getDate() + "/" + (f.getMonth() +1) + "/" + f.getFullYear()+ " "+f.getHours()+":"+f.getMinutes()+":"+f.getSeconds();
}

function createsummernote (namesummer){
    $('#'+namesummer).summernote({
        disableDragAndDrop: true,
        placeholder: 'Hello',
        tabsize: 0.5,
        height: 200,
        blockquoteBreakingLevel: 2,
        lineHeight: 5
      });
}

function w_update_work(id){
    var dataup={                    
        "name" : $("#w_name_"+id).text(),
        "host": $("#w_host_"+id).text(),
        "inforelevant": $("#sn_info_"+id).summernote('code'),
        "inforeview": $("#sn_notes_"+id).summernote('code'),
        "infoall": $("#sn_all_"+id).summernote('code'),
        "state": true
    };
    console.log(dataup);
    $.ajax({
        url: '/works/'+id,
        type: 'put',
        dataType: 'json',
        contentType: 'application/json',
        data: JSON.stringify(dataup),
        success: (result)=>{
            console.log("datos del work save");
            msmnotication(true,'Update');

        },
        error: (result)=>{
            console.log(result);
            msmnotication(false,'Update');
        }
    });

    
}

function abrirworktab(id){
    $.ajax({
        url: '/works/'+id,
        type: 'get',
        success: (datanewwork)=>{
            console.log("new proyec creado");
            $("#tab_name_work").append('<li><a href="#host_'+datanewwork.id+'" data-toggle="tab">Host '+datanewwork.id+'</a><span>x</span></li>');
            $("#tab_content_woks").append(rendertab(datanewwork));

            createsummernote("sn_info_"+datanewwork.id);
            createsummernote("sn_notes_"+datanewwork.id);
            createsummernote("sn_all_"+datanewwork.id);
            


            $('#tab_name_work a[href="#host_' + datanewwork.id + '"]').tab('show');            
        },
        error: (result)=>{
            console.log(result)
        }
    });
}

function msmnotication(type,msm){

    /**
     * <script src="tools/toast2/bootstrap-notify.min.js"></script>
     * msmnotication(true,'Create');
     * msmnotication(false,'Create');
     * msmnotication(true,'Update');
     */
    
    if(type){
        $.notify({
            message: msm+" successfully !!"
        },{
            type: 'success',
            delay: 50,    
            animate: {
                enter: 'animated fadeInRight',
                exit: 'animated fadeOutRight'
            }
        }
        );

    }else if(!type){
        $.notify({
            message: "Error to "+msm+" !!"
        },{
            type: 'danger',
            delay: 50,    
            animate: {
                enter: 'animated fadeInRight',
                exit: 'animated fadeOutRight'
            }
        }
        );
    }
}