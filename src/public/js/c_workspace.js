$(document).ready(function() {

    
/* new project */
$('#ws_select_w').on('change', function() {
    if( this.value == "0" ){
        $("#workadvance").show();    
    }else{
        $("#workadvance").hide();    
    }
  });

  
  $('#ws_select_type').on('change', function() {
    if( this.value == "1" ){
        $("#ws_select_w").show();    
        $("#ws_select_w").val('1');
        $("#workadvance").hide();   
    }else{
        $("#ws_select_w").hide();
        $("#workadvance").hide();
        $("#infraesadvace").show();    

    }
  });

$("#btn_new").click(function() {

    if($("#ws_select_type").val() == "1"){
        console.log("aplicac")
        if($("#ws_select_w").val() == "1"){
            /*default */
            new_default();
        }else{
            console.log("no default");
            new_nodefault();
        }

    }
});



    $('.tree').treegrid({
                expanderExpandedClass: 'glyphicon glyphicon-minus',
                expanderCollapsedClass: 'glyphicon glyphicon-plus'
            });

            $.ajax({
                url: '/workspace_works',
                type: 'get',                
                success: (data)=>{
                    var conta_treegrid=0;
                    var conta_parent=0;
                    var conta_aux=0;
                    $.when( $.each(data, function(i, item) {
                        conta_treegrid++;
                        conta_parent++;

                       
                            $("#datatreews").append(
                                `<tr class="treegrid-${conta_treegrid}">
                                <td>${data[i].name}</td><td>${data[i].Works[0].name}</td>
                                <td>
                                    <a class="btn btn-success btn-xs" href="/workuse/${data[i].id}/${data[i].Works[0].id}">Use</a>
                                    <button class="btn btn-info btn-xs" onclick="call_modal_edit_ws('${data[i].id}','${data[i].name}')">Edit</button>
                                    <button class="btn btn-danger btn-xs" onclick="call_eliminar_ws('${data[i].id}','${data[i].name}')">Del</button>
                                    <a class="btn btn-warning btn-xs" href="/reporthtmlall/${data[i].id}" target="_blank">Html</a>
                                </td>
                            </tr>`  
                              );
                        

                        
                        console.log(data[i].name);
                        conta_aux=conta_parent
                        $.each(data[i].Works, function(a, item) {
                            if(data[i].Works[a].state){
                                conta_treegrid++;
                            conta_parent++;
                            $("#datatreews").append(
                                `<tr class="treegrid-${conta_treegrid} treegrid-parent-${conta_aux}">
                                <td>${data[i].Works[a].name}</td><td>${data[i].Works[a].host}</td>
                                <td>
                                    <a class="btn btn-success btn-xs" href="/workuse/${data[i].id}/${data[i].Works[a].id}">Use</a>
                                                             
                                    <a class="btn btn-warning btn-xs" href="/report/${data[i].Works[a].id}" target="_blank">Html</a>
                                    <button class="btn btn-danger btn-xs" onclick="call_eliminar_work('${data[i].Works[a].id}')">Del</button>
                                </td>
                            </tr>`  
                              );
                            console.log("add-->"+data[i].Works[a].name);
                            }else{
                                console.log("desative-->"+data[i].Works[a].name);
                            }
                            

                        })
                    }) 
                    ).then(()=>{
                        $('.tree-ws').treegrid({
                            expanderExpandedClass: 'glyphicon glyphicon-minus',
                            expanderCollapsedClass: 'glyphicon glyphicon-plus'
                        });
                        $('.tree-ws').treegrid('collapseAll');
                        $('#togglealll').click(function () {
                            
                            $('.tree-ws').treegrid('collapseAll');
                        });
                        $('#expandAlll').click(function () {
                            
                            $('.tree-ws').treegrid('expandAll');
                        });
                    });

                   
                    
                }
            });

        
    
    
});

function new_default(){
    var dataspace={
        "name" : $("#w_name").val().toUpperCase(),
        "type" : true
    }
    $.ajax({
        url: '/workspace',
        type: 'post',
        dataType: 'json',
        contentType: 'application/json',
        data: JSON.stringify(dataspace),
        success: (result)=>{
            console.log(result)
            //create work
                var datawork={                    
                    "name" : "Work  "+getfecha(),
                    "host": "192.168.0.1",
                    "inforelevant": "<h4><h5><h3><h4><ul><li>URLs:</li></ul><ul><li>User :&nbsp;</li></ul><ul><li>Passwords:</li></ul><p><br></p></h4></h3></h5></h4>",
                    "inforeview": "<h4></h4><h5></h5><h3></h3><p><ul></ul><ul></ul><ul></ul></p><ul><li><br></li><li><br></li><li><br></li></ul>",
                    "infoall": "<p></p><p></p><p></p><p><span style='font-size: 24px;'>Pruebas realizadas</span></p><hr><p></p><p><br></p><p><br></p><p></p><hr><br><p></p><p><br></p><hr><br><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p><br></p><hr><p><br></p><p><br></p><p><br></p><hr><p><br></p>",
                    "creationdate": "na",
                    "state": true,
                    "worksapce_id": result.id
                };       
                $.ajax({
                    url: '/works',
                    type: 'post',
                    dataType: 'json',
                    contentType: 'application/json',
                    data: JSON.stringify(datawork),
                    success: (result2)=>{
                        console.log("new proyec creado");
                        window.location.href = "/workuse/"+result.id+"/"+result2.id;                  
                    },
                    error: (result)=>{
                        console.log(result)
                    }
                });
        }
    });
}

function new_nodefault(){
    var dataspace={
        "name" : $("#w_name").val().toUpperCase(),
        "type" : true
    }
    $.ajax({
        url: '/workspace',
        type: 'post',
        dataType: 'json',
        contentType: 'application/json',
        data: JSON.stringify(dataspace),
        success: (result)=>{
            console.log(result)
            //create work
                var datawork={                    
                    "name" : $("#w_name").val(),
                    "host": $("#w_input_host").val(),
                    "inforelevant": $("#w_input_info").val(),
                    "inforeview": "<h4></h4><h5></h5><h3></h3><p><ul></ul><ul></ul><ul></ul></p><ul><li><br></li><li><br></li><li><br></li></ul>",
                    "infoall": "<p></p><p></p><p></p><p><span style='font-size: 24px;'>Pruebas realizadas</span></p><hr><p></p><p><br></p><p><br></p><p></p><hr><br><p></p><p><br></p><hr><br><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p><br></p><hr><p><br></p><p><br></p><p><br></p><hr><p><br></p>",
                    "creationdate": "na",
                    "state": true,
                    "worksapce_id": result.id
                };       
                $.ajax({
                    url: '/works',
                    type: 'post',
                    dataType: 'json',
                    contentType: 'application/json',
                    data: JSON.stringify(datawork),
                    success: (result2)=>{
                        console.log("new proyec creado");
                        window.location.href = "/workuse/"+result.id+"/"+result2.id;                    
                    },
                    error: (result)=>{
                        console.log(result)
                    }
                });
        }
    });
}


/** eliminar workspace*/
function call_eliminar_ws(idw,namew){
    $("#delete_id_ws").val(idw);
    $("#delete_name_ws").text("--> "+namew+" <--");
    $("#modal_delete_ws").modal();
}
function eliminar_ws(){
    
    $.ajax({
        url: '/workspace/'+$("#delete_id_ws").val(),
        type: 'delete',
        dataType: 'json',
        success: (result2)=>{
            console.log("eliminado");                   
        },
        error: (result)=>{
            console.log("error al eliminar"+result)
        }
    });
}
/** desactivar works*/
function call_eliminar_work(id){
    $("#delete_id_w").val(id);
    $("#modal_delete_w").modal();
}

function eliminar_w(type){
    if(type == 0){
        $.ajax({
            url: '/works/'+$("#delete_id_w").val(),
            type: 'put',
            dataType: 'json',
            contentType: 'application/json',
            data: JSON.stringify({state:false}),
            success: (result)=>{
                console.log("desactivado");
                window.location.href = "/workspaces";                   
            },
            error: (result)=>{
                console.log("error al descaticvar"+result)
            }
        });
    }else if(type == 1){
        $.ajax({
            url: '/works/'+$("#delete_id_w").val(),
            type: 'delete',
            dataType: 'json',
            success: (result2)=>{
                window.location.href = "/workspaces"; 
                console.log("eliminado");                   
            },
            error: (result)=>{
                console.log("error al eliminar"+result)
            }
        });

    }
    
}

function call_modal_edit_ws(id,name){
    $("#edit_name_ws").val(name);
    $("#edit_id_ws").val(id);
    $("#modal_edit_ws").modal();
}

function editar_ws(){

    $.ajax({
        url: '/workspace/'+$("#edit_id_ws").val(),
        type: 'put',
        dataType: 'json',
        contentType: 'application/json',
        data: JSON.stringify({name:$("#edit_name_ws").val()}),
        success: (result)=>{
            console.log("desactivado");
            window.location.href = "/workspaces";                   
        },
        error: (result)=>{
            console.log("error al descaticvar"+result)
        }
    });
}


function getfecha(){
    var f = new Date();
    return f.getDate() + "/" + (f.getMonth() +1) + "/" + f.getFullYear();
}