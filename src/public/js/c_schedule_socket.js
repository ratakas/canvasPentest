var socket = io();
socket.on('additem', setAdditem)
socket.on('setitem', setStateItem)
socket.on('setNameItem', setNameItem)


function addMessages(test){
    alert(test)
}

//add item
function sendAdditem(idsc){
    var data ={
        task: "test",
        state: "1",
        schedule_id: idsc
    }
    $.ajax({
        url: '/api/scheduleitem',
        type: 'post',
        dataType: 'json',
        contentType: 'application/json',
        async:true,
        data: JSON.stringify(data)
    })

}


//edit nameitem
function sendNameItem(id,task){
    var data={
        id: id,
        task:task
    }
    $.ajax({
        url: '/api/schedulename',
        type: 'put',
        dataType: 'json',
        contentType: 'application/json',
        async:true,
        data: JSON.stringify(data)
    })    

}

function setNameItem(data){
    
    $(".sci"+data.id+"_nameitem").text(data.task)
}

//estado items

function sendState(idelemto,state){
   
    $.ajax({
        url: '/api/scheduleitem',
        type: 'put',
        dataType: 'json',
        contentType: 'application/json',
        async:true,
        data: JSON.stringify({id:idelemto,state:parseInt(state)})
    })
}

function setStateItem(data){
    console.log("data: "+data)
    var idelemto = data.id;
    var state = data.state;
    console.log("data: "+state)

    el = $(".sci"+idelemto+"_draggable")

    el.appendTo(".sci"+idelemto+"_drop"+state);

    colordropp(idelemto,state)

}


/**order */

//** */

function setAdditem(item){
   

    $("#sc_tbody_"+item.schedule_id).append(`<tr>
    <td style="width: 5%" class="add_story"> x </td> 
        <td style="width: 52%" >
        <textarea class="sci${item.id}_nameitem textareagg">${item.task}</textarea>      
        </td>                                          
        <td state="1"  class="sci${item.id}_droppable sci${item.id}_drop1" style="width: 16%;background-color:yellow">                </td>
        <td state="2"  class="sci${item.id}_droppable sci${item.id}_drop2" style="width: 16%"></td>
        <td state="3"  class="sci${item.id}_droppable sci${item.id}_drop3" style="width: 16%"></td>    
    </tr> `)


    //edititem falta
    $('.sci'+item.id+'_nameitem').focusout(function(data) {
                
        //console.log(data.target.value)
        sendNameItem(item.id,data.target.value)
      });

    switch(item.state){
        case 1:
            $(".sci"+item.id+"_drop"+item.state).append(`<img class="sci${item.id}_draggable" src="https://www.w3schools.com/html/img_w3slogo.gif" alt="">`)
            break;
        case 2:
        $(".sci"+item.id+"_drop"+item.state).append(`<img class="sci${item.id}_draggable" src="https://www.w3schools.com/html/img_w3slogo.gif" alt="">`)
            break;
        case 3:
            $(".sci"+item.id+"_drop"+item.state).append(`<img class="sci${item.id}_draggable" src="https://www.w3schools.com/html/img_w3slogo.gif" alt="">`)
            break;
    }
    colordropp(item.id,item.state)
    //call dropp
    $(".sci"+item.id+"_droppable").droppable({
        accept: ".sci"+item.id+"_draggable",
        drop: function( event, ui ) {
          cloned = ui.helper.clone().css({'position': '', 'top': '', 'left': ''});
          setDraggable(cloned, false)
          
          
          $( this )
          .addClass( "ui-state-" )
          .append(cloned)
          ui.helper.remove();
        
          colordropp(item.id,$(this).attr("state"))
          console.log($(this).attr("state"))

          sendState(item.id,$(this).attr("state"))

          
        }
      });
      setDraggable($(".sci"+item.id+"_draggable"), false);

      $("#sc_tbody_"+idsc+" td").not('.add_story').mousedown(function(event){
        event.stopImmediatePropagation();
    });

}

